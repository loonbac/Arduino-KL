<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor Bluetooth HC-05</title>
<style>
body {
    background: #121212;
    color: #00ff99;
    font-family: 'Courier New', monospace;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
}
h2 {
    text-align: center;
    color: #00ff99;
}
#status {
    text-align: center;
    padding: 10px;
    margin: 10px 0;
    background: #1a1a1a;
    border-radius: 5px;
}
#log {
    white-space: pre-wrap;
    background: #000;
    padding: 15px;
    border: 2px solid #00ff99;
    border-radius: 5px;
    height: 400px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.5;
}
.button-container {
    text-align: center;
    margin: 20px 0;
}
button {
    padding: 12px 30px;
    font-size: 16px;
    cursor: pointer;
    background: #00ff99;
    color: #000;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    transition: all 0.3s;
}
button:hover {
    background: #00cc77;
    transform: scale(1.05);
}
button:disabled {
    background: #555;
    cursor: not-allowed;
    transform: none;
}
</style>
</head>
<body>

<h2>üîê Monitor en Tiempo Real (Bluetooth HC-05)</h2>

<div id="status">Estado: Desconectado</div>

<div class="button-container">
    <button id="connect">üîå Conectar Bluetooth</button>
</div>

<div id="log"></div>

<script>
let device;
let characteristic;
let logElement = document.getElementById("log");
let statusElement = document.getElementById("status");
let connectButton = document.getElementById("connect");

// UUID del servicio Serial Bluetooth (HC-05 usa el servicio SPP est√°ndar)
const SERVICE_UUID = "00001101-0000-1000-8000-00805f9b34fb"; // SPP UUID

async function conectarBluetooth() {
    try {
        statusElement.textContent = "Estado: Buscando dispositivos...";
        statusElement.style.color = "#ffaa00";
        
        // Solicitar dispositivo Bluetooth
        device = await navigator.bluetooth.requestDevice({
            filters: [
                { services: [SERVICE_UUID] }
            ],
            optionalServices: [SERVICE_UUID]
        });

        statusElement.textContent = "Estado: Conectando a " + device.name + "...";

        // Conectar al dispositivo
        const server = await device.gatt.connect();
        
        statusElement.textContent = "Estado: Obteniendo servicio...";
        
        // Obtener el servicio
        const service = await server.getPrimaryService(SERVICE_UUID);
        
        statusElement.textContent = "Estado: Obteniendo caracter√≠stica...";
        
        // Obtener la caracter√≠stica (para HC-05, usualmente la primera)
        const characteristics = await service.getCharacteristics();
        characteristic = characteristics[0];
        
        // Iniciar notificaciones
        await characteristic.startNotifications();
        
        // Escuchar datos entrantes
        characteristic.addEventListener('characteristicvaluechanged', manejarDatos);
        
        statusElement.textContent = "Estado: ‚úÖ Conectado a " + device.name;
        statusElement.style.color = "#00ff99";
        connectButton.textContent = "‚úÖ Conectado";
        connectButton.disabled = true;
        
        logElement.innerHTML += "=== Conexi√≥n establecida ===\n";
        logElement.innerHTML += "Dispositivo: " + device.name + "\n";
        logElement.innerHTML += "=== Iniciando captura ===\n\n";

    } catch (error) {
        console.error("Error de conexi√≥n:", error);
        statusElement.textContent = "Estado: ‚ùå Error - " + error.message;
        statusElement.style.color = "#ff3333";
        
        if (error.name === 'NotFoundError') {
            alert('No se encontr√≥ ning√∫n dispositivo Bluetooth HC-05.\n\nAseg√∫rate de que:\n1. El HC-05 est√© encendido y emparejado\n2. El Bluetooth est√© habilitado en tu PC\n3. Est√©s usando Chrome/Edge con HTTPS o localhost');
        } else {
            alert("Error al conectar: " + error.message);
        }
    }
}

function manejarDatos(event) {
    // Leer los datos del buffer
    const value = event.target.value;
    const decoder = new TextDecoder('utf-8');
    const texto = decoder.decode(value);
    
    // Procesar el texto (convertir tokens a formato legible si lo deseas)
    let textoFormateado = texto
        .replace(/<EN>/g, '\n')
        .replace(/<BK>/g, '[‚Üê]')
        .replace(/<LEFT>/g, '[‚Üê]')
        .replace(/<RIGHT>/g, '[‚Üí]')
        .replace(/<UP>/g, '[‚Üë]')
        .replace(/<DOWN>/g, '[‚Üì]');
    
    // Agregar al log
    logElement.innerHTML += textoFormateado;
    
    // Hacer scroll autom√°tico
    logElement.scrollTop = logElement.scrollHeight;
}

// Manejar desconexi√≥n
async function manejarDesconexion() {
    if (device && device.gatt.connected) {
        await device.gatt.disconnect();
        statusElement.textContent = "Estado: Desconectado";
        statusElement.style.color = "#ff9900";
        connectButton.textContent = "üîå Conectar Bluetooth";
        connectButton.disabled = false;
        logElement.innerHTML += "\n=== Conexi√≥n terminada ===\n";
    }
}

connectButton.addEventListener("click", conectarBluetooth);

// Detectar cuando el usuario cierra la p√°gina
window.addEventListener('beforeunload', manejarDesconexion);

// Mensaje de ayuda inicial
logElement.innerHTML = `Instrucciones:
1. Haz clic en "Conectar Bluetooth"
2. Selecciona tu dispositivo HC-05 en la lista
3. Los datos capturados aparecer√°n aqu√≠ en tiempo real

Nota: Debes usar Chrome o Edge, y la p√°gina debe estar en HTTPS o localhost.
Si no ves tu HC-05, aseg√∫rate de que est√© emparejado con tu PC.

========================================\n\n`;
</script>

</body>
</html>
